<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Pragma" content="no-cache">
    <title>Data Inquirer</title>
    
    <!-- ASCOT Basic Style Sheets -->
    <link href="/css/reset.css" rel="stylesheet" type="text/css">
    <link href="/css/text.css" rel="stylesheet" type="text/css"> 
    <link href="/css/widgets.css" rel="stylesheet" type="text/css"> 
    
    <style type="text/css">
        svg {
          font-size: 10px;
        }
        
        .axis {
          shape-rendering: crispEdges;
        }
        
        .axis path, .axis line {
          fill: none;
          stroke-width: .5px;
        }
        
        .x.axis path {
          stroke: #000;
        }
        
        .x.axis line {
          stroke: #fff;
          stroke-opacity: .5;
        }
        
        .y.axis line {
          stroke: #ddd;
        }
        
        path.line {
          fill: none;
          stroke: #000;
          stroke-width: .5px;
        }
        
        rect.pane {
          cursor: move;
          fill: none;
          pointer-events: all;
        }
        
    </style>
    
</head>
<body>
    <div id="content" class="extraPadding">
        <h2>SciDB Query</h2>
        <div id="divQueryBox" style="width : 96%; margin-top: 10px;">
            Query String: 
            <div>
                <textarea id="txtQueryString" rows="5" style="width : 100%"></textarea>
            </div>
        </div>
        <div>
            <input id="submitQuery" type="button" value="Submit" style="margin-left: 0px"/>
            <div id="divStatusText" style="display: inline;">
            </div> 
        </div>
        <div>
            <input id="moveMode" type="radio" name="mode" checked="checked" />Move
            <input id="drawMode" type="radio" name="mode" /> Draw
        </div>
        <canvas id="query_image">
        </canvas>
    </div>
</body>
<script src="http://code.jquery.com/jquery-1.8.1.min.js" type="text/javascript"></script>
<script src="/util.js" type="text/javascript"></script>
<script src="/highcharts.src.js" type="text/javascript"></script>
<script src="/jquery.postmessage.min.js" type="text/javascript"></script>
<script type="text/javascript">

var scidbServerAPI = "http://rio.cs.washington.edu:5550/"
  
// Status Icons
var ICON_URL_SELECTED = '/images/targetYellow.png';
var ICON_URL_DEFAULT = '/images/target.png';
var ICON_URL_SPINNER = '/images/spinnerSmallWhite.gif';
var ICON_URL_ERROR = '/images/errorIcon.gif';
var ICON_URL_SUCCESS = '/images/successIcon.gif';

var myFields = {}

// Gadget State Variables
var viewportBounds;
var currentQuery = {};
var boundSources = [];

// create HR object
gadget.init = function(callback){
    gadget.update = function(){};
    callback();
}

gadget.saveState = function(){
  return {
  }
};

gadget.loadState = function(state){
};

var moveMode = true;
var image;
var canvas;
var ctx;
var rectangle;
var lastX;
var lastY;
var dragStart;
var scaleFactor;

function showStatus(iconUrl, text){
    var statusDiv = $('#divStatusText')[0];
    text = text || "DataSet Loaded";
    var status = text; 
    if (iconUrl !== "") {
        status = '<img id="imgStatus" style="vertical-align:middle;" src="' + iconUrl + '" /> ' + "<span style='vertical-align:middle;'>" + text + "</span>";
    } 
    statusDiv.style.visibility = 'inline';
    statusDiv.innerHTML = status;
}

function redraw() {
    var canvas = document.getElementById('query_image');
    var ctx = canvas.getContext('2d');
    // Clear the entire canvas
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.restore();
    
    ctx.drawImage(image, 0, 0);
    
    ctx.strokeRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);
}

window.onload = function() {
    // Set Up Canvas
    canvas = document.getElementById('query_image');
    canvas.width = 800; 
    canvas.height = 600;
    
    ctx = canvas.getContext('2d');
    trackTransforms(ctx);
    
    lastX = canvas.width / 2;
    lastY = canvas.height / 2;
    dragStart;
    scaleFactor = 1.1;
    
    rectangle = new Object();
    rectangle.x = 0;
    rectangle.y = 0;
    rectangle.height = 0;
    rectangle.width = 0;
    
    // Set Up Buttons
    $('#submitQuery').on("click", function() {
        //showStatus(ICON_URL_SPINNER, "Processing Query...");
        //setTimeout('image = new Image;image.onload = function () {redraw();};image.shiftX = 456;image.shiftY = 456;image.src = "http://4.bp.blogspot.com/-6c-aMbDNt_g/TpiMyufNiLI/AAAAAAAAAGY/Xpn0DpAP-DI/s640/cute+cat+with+doll+pictures+008.jpg";showStatus(ICON_URL_SUCCESS, "Query Complete.");', 100);
        //return;
        
        var request = {};
        //request['query'] =  $('#query-text').attr('value');
        request['query'] = "select sum(data) from CCD2 group by row, col";
        request['iterative'] = false;
        request['iteration'] = 0;
        request['z_scale'] = true;
        request['language'] = 'aql';
        
        console.log('Sending Request:' + JSON.stringify(request));
        
        $.ajax({
            url: scidbServerAPI + "process/query/",
            type: "POST",
            contentType: "application/json",
            dataType: "jsonp",
            data: request,
            beforeSend: function() { showStatus(ICON_URL_SPINNER, "Processing Query..."); },
            error: function() { showStatus(ICON_URL_ERROR, "A network errored occured while processing the query."); },
            success: function(result) {
                console.log("Received Result:");
                console.log(result);
                if (result['status'] === 'OK') {
                    showStatus(ICON_URL_SUCCESS, "Query Complete.");
                    
                    // draw_query
                    image = new Image;
                    image.onload = function () {
                        redraw();
                    };
                    image.shiftX = result['image_shiftX'];
                    image.shiftY = result['image_shiftY'];
                    //image.src = "data:image/png;base64," + image_data;
                    image.src = "http://4.bp.blogspot.com/-6c-aMbDNt_g/TpiMyufNiLI/AAAAAAAAAGY/Xpn0DpAP-DI/s640/cute+cat+with+doll+pictures+008.jpg";
                } else {
                    showStatus(ICON_URL_ERROR, "An errored occured while processing the query.");
                }
            }
        });
    });
    $('#moveMode').on("click", function() {
            moveMode = true;
    });
    $('#drawMode').on("click", function() {
            moveMode = false;
    });
        
    var evt_mousedown = function (event) {
        document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
        lastX = event.offsetX || (event.pageX - canvas.offsetLeft);
        lastY = event.offsetY || (event.pageY - canvas.offsetTop);
        dragStart = ctx.transformedPoint(lastX, lastY);
        
        if (moveMode) {
            
        } else { // draw mode
            rectangle.x = 0;
            rectangle.y = 0;
            rectangle.height = 0;
            rectangle.width = 0;
            
            gadget.notify('queryBoundsChanged', rectangle);
            
            redraw();
        }
    };
    
    var evt_mousemove = function (event) {
        lastX = event.offsetX || (event.pageX - canvas.offsetLeft);
        lastY = event.offsetY || (event.pageY - canvas.offsetTop);
        
        if (!dragStart) {
            return;
        }
        
        if (moveMode) {
            var pt = ctx.transformedPoint(lastX, lastY);
            ctx.translate(pt.x-dragStart.x, pt.y-dragStart.y);
            redraw();
        } else { // draw mode
            var pt = ctx.transformedPoint(lastX, lastY);
            
            var x = Math.min(pt.x,  dragStart.x);
            var y = Math.min(pt.y,  dragStart.y);
            var w = Math.abs(pt.x - dragStart.x);
            var h = Math.abs(pt.y - dragStart.y);
            
            if (w && h) {
                // calculate cursor location to image pix
                var cursorXNative =   image.shiftX + x;
                var cursorYNative =  image.shiftY + image.height - y;
                
                rectangle.img_x = cursorXNative;
                rectangle.img_y = cursorYNative;
                rectangle.x = x;
                rectangle.y = y;
                rectangle.height = h;
                rectangle.width = w;
                
                gadget.notify('queryBoundsChanged', rectangle);
            }
            
            redraw();
        }
    };
    
    var evt_mouseup = function (event) {
        dragStart = null;
    };
    
    var evt_scroll = function (event) {
        var clicks = event.wheelDelta ? event.wheelDelta/40 : event.detail ? -event.detail : 0;
            if (event) {
                var pt = ctx.transformedPoint(lastX, lastY);
                ctx.translate(pt.x, pt.y);
                var factor = Math.pow(scaleFactor, clicks);
                ctx.scale(factor, factor);
                ctx.translate(-pt.x, -pt.y);
                redraw();
            }
        return event.preventDefault() && false;
    };
    
    // Attach event listeners.
    canvas.addEventListener('mousedown', evt_mousedown, false);
    canvas.addEventListener('mousemove', evt_mousemove, false);
    canvas.addEventListener('mouseup',   evt_mouseup, false);
    canvas.addEventListener('DOMMouseScroll', evt_scroll, false);
    canvas.addEventListener('mousewheel', evt_scroll, false);
    
}; // End of onload


// Adds ctx.getTransform() - returns an SVGMatrix
// Adds ctx.transformedPoint(x,y) - returns an SVGPoint
function trackTransforms(ctx){
    var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
    var xform = svg.createSVGMatrix();
    ctx.getTransform = function(){ return xform; };
    
    var savedTransforms = [];
    var save = ctx.save;
    ctx.save = function(){
        savedTransforms.push(xform.translate(0,0));
        return save.call(ctx);
    };
    var restore = ctx.restore;
    ctx.restore = function(){
        xform = savedTransforms.pop();
        return restore.call(ctx);
    };

    var scale = ctx.scale;
    ctx.scale = function(sx,sy){
        xform = xform.scaleNonUniform(sx,sy);
        return scale.call(ctx,sx,sy);
    };
    var rotate = ctx.rotate;
    ctx.rotate = function(radians){
        xform = xform.rotate(radians*180/Math.PI);
        return rotate.call(ctx,radians);
    };
    var translate = ctx.translate;
    ctx.translate = function(dx,dy){
        xform = xform.translate(dx,dy);
        return translate.call(ctx,dx,dy);
    };
    var transform = ctx.transform;
    ctx.transform = function(a,b,c,d,e,f){
        var m2 = svg.createSVGMatrix();
        m2.a=a; m2.b=b; m2.c=c; m2.d=d; m2.e=e; m2.f=f;
        xform = xform.multiply(m2);
        return transform.call(ctx,a,b,c,d,e,f);
    };
    var setTransform = ctx.setTransform;
    ctx.setTransform = function(a,b,c,d,e,f){
        xform.a = a;
        xform.b = b;
        xform.c = c;
        xform.d = d;
        xform.e = e;
        xform.f = f;
        return setTransform.call(ctx,a,b,c,d,e,f);
    };
    var pt  = svg.createSVGPoint();
    ctx.transformedPoint = function(x,y){
        pt.x=x; pt.y=y;
        return pt.matrixTransform(xform.inverse());
    }
}
</script>
</html>
