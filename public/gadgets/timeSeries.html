<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Pragma" content="no-cache">
    <title>Data Inquirer</title>
    
    <!-- ASCOT Basic Style Sheets -->
    <link href="/css/reset.css" rel="stylesheet" type="text/css">
    <link href="/css/text.css" rel="stylesheet" type="text/css"> 
    <link href="/css/widgets.css" rel="stylesheet" type="text/css"> 
    
    <style type="text/css">
        svg {
          font-size: 10px;
        }
        
        .axis {
          shape-rendering: crispEdges;
        }
        
        .axis path, .axis line {
          fill: none;
          stroke-width: .5px;
        }
        
        .x.axis path {
          stroke: #000;
        }
        
        .x.axis line {
          stroke: #fff;
          stroke-opacity: .5;
        }
        
        .y.axis line {
          stroke: #ddd;
        }
        
        path.line {
          fill: none;
          stroke: #000;
          stroke-width: .5px;
        }
        
        rect.pane {
          cursor: move;
          fill: none;
          pointer-events: all;
        }
        
    </style>
    
</head>
<body>
    <div id="content" class="extraPadding">
        <h2>Time Series</h2>
        <div id="divQueryBox" style="width : 96%; margin-top: 10px;">
            Query String: <input onclick="generateQuery();" type="button" value="Generate Query" />
            <div>
                <textarea id="txtQueryString" rows="5" style="width : 100%"></textarea>
            </div>
        </div>
        <div>
            <input onclick="executeTimeSeries();" type="button" value="Submit" style="margin-left: 0px"/>
            <div id="divStatusText" style="display: inline;">
            </div> 
        </div>
        <div id="timeseries_plot" style="height: 400px">
        </div>
    </div>
</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.js" type="text/javascript"></script>
<script src="/util.js" type="text/javascript"></script>
<script src="/highcharts.src.js" type="text/javascript"></script>
<script src="/jquery.postmessage.min.js" type="text/javascript"></script>
<script type="text/javascript">

var scidbServerAPI = "rio.cs.washington.edu:5555"
  
// Status Icons
var ICON_URL_SELECTED = '/images/targetYellow.png';
var ICON_URL_DEFAULT = '/images/target.png';
var ICON_URL_SPINNER = '/images/spinnerSmallWhite.gif';
var ICON_URL_ERROR = '/images/errorIcon.gif';
var ICON_URL_SUCCESS = '/images/successIcon.gif';

var myFields = {}

// Gadget State Variables
var viewportBounds;
var currentQuery = {};
var boundSources = [];

var bounds;

var test_result = {
    "dimnames": ["xndvi", "yndvi"],
    "dimbases": {"xndvi": "1", "yndvi": "1"},
    "names": [{"name": "attrs.avg_ndvi", "isattr": true}, {"name": "dims.xndvi", "isattr": false}, {"name": "dims.yndvi", "isattr": false}],
    "dimwidths": {"xndvi": 3600000, "yndvi": 1800000},
    "data": [
        {"flux": 0.5}, 
        {"flux": 0.57}, 
        {"flux": 0.58}, 
        {"flux": 0.46},
        {"flux": 0.44},
        {"flux": 0.41},
        {"flux": 0.5},
        {"flux": 0.6},
        {"flux": 0.49},
        {"flux": 0.47},
        {"flux": 0.46},
        {"flux": 0.56},
        {"flux": 0.59},
        {"flux": 0.49},
        {"flux": 0.43},
        {"flux": 0.46},
        {"flux": 0.43},
        {"flux": 0.45},
        {"flux": 0.61},
        {"flux": 0.48},
        {"flux": 0.44},
        {"flux": 0.49},
        {"flux": 0.47},
        {"flux": 0.48},
        {"flux": 0.63},
        {"flux": 0.39},
        {"flux": 0.64},
        {"flux": 0.64},
        {"flux": 0.53},
        {"flux": 0.57},
        {"flux": 0.55},
        {"flux": 0.55},
        {"flux": 0.51},
        {"flux": 0.61},
        {"flux": 0.49},
        {"flux": 0.52},
        {"flux": 0.4},
        {"flux": 0.44},
        {"flux": 0.51},
        {"flux": 0.35},
        {"flux": 0.41},
        {"flux": 0.43},
        {"flux": 0.5},
        {"flux": 0.51},
        {"flux": 0.51},
        {"flux": 0.57},
        {"flux": 0.49},
        {"flux": 0.67},
        {"flux": 0.45},
        {"flux": 0.55},
        {"flux": 0.54},
        {"flux": 0.53},
        {"flux": 0.4},
        {"flux": 0.56},
        {"flux": 0.52},
        {"flux": 0.53},
        {"flux": 0.49},
        {"flux": 0.48},
        {"flux": 0.51},
        {"flux": 0.49},
        {"flux": 0.52},
    ], 
    "types": {"attrs.avg_ndvi": "double", "dims.xndvi": "int32", "dims.yndvi": "int32"}
};

gadget.init = function(callback){
    gadget.update = function(){};
    
    bounds = new Object();
    bounds.x = 0;
    bounds.y = 0;
    bounds.height = 0;
    bounds.width = 0;
    
    gadget.onNotification('queryBoundsChanged', function(rectangle) {
            bounds.x = rectangle.img_x;
            bounds.y = rectangle.img_y;
            bounds.height = rectangle.height;
            bounds.width = rectangle.width;
    });
    
    callback();
}

gadget.saveState = function(){
  return {}
};

gadget.loadState = function(state){
};

function generateQuery() {
    var genQuery = " a time series query with bounds of " + JSON.stringify(bounds);
    $("#txtQueryString").html(genQuery);
}
 
function executeTimeSeries() {
    showStatus(ICON_URL_SPINNER, "Processing Time Series...");
    setTimeout('draw_timeseries(test_result);showStatus(ICON_URL_SUCCESS, "Time Series Complete.");', 100);
    return;
    
    var request = {};
    request['query'] =  $('#query-text').attr('value');

    if($('#afl').attr('checked')) {
        request['language'] =  'afl';
    } else {
    	request['language'] = 'aql';
    }
    
    console.log('Sending Request:' + JSON.stringify(request));
    
    $.ajax({
        url: scidbServerAPI + "/process/timeseries/",
        type: "POST",
        contentType: "application/json",
        dataType: "json",
        data: JSON.stringify(request),
        beforeSend: function() { showStatus(ICON_URL_SPINNER, "Processing Time Series..."); },
        error: function() { showStatus(ICON_URL_ERROR, "A network errored occured while processing the time series."); },
        success: function(result) {
            console.log("Received Result:");
            console.log(result);
            if (result['status'] === 'OK') {
                showStatus(ICON_URL_SUCCESS, "Time Series Complete.");
                draw_timeseries(result['data']);
            } else {
                showStatus(ICON_URL_ERROR, "An errored occured while processing the time series.");
            }
        }
    });
}

function showStatus(iconUrl, text){
  var statusDiv = $('#divStatusText')[0];
  text = text || "DataSet Loaded";
  var status = text; 
  if (iconUrl !== "") {
    status = '<img id="imgStatus" style="vertical-align:middle;" src="' + iconUrl + '" /> ' + "<span style='vertical-align:middle;'>" + text + "</span>";
  } 
  statusDiv.style.visibility = 'inline';
  statusDiv.innerHTML = status;
}


function draw_timeseries(data_json) {
    var data = data_json['data'];
    var y_axis = 'flux';
    
    var y_data = [];
    for (var i=0; i<data.length; i++) {
        y_data[i] = (data[i][y_axis])
    }
    
    var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'timeseries_plot',
            type: 'scatter',
            marginBottom: 25
        },
        title: {
            text: 'Timeseries',
            x: -20 //center
        },
        subtitle: {
            text: '',
            x: -20
        },
        xAxis: {
        },
        yAxis: {
            title: {
                text: y_axis
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            formatter: function() {
                    return '(' + this.x + ', ' + this.y + ')';
            }
        },
        legend: {
            enabled: false
        },
        series: [{ data: y_data }]
    });
    
}
</script>
</html>
